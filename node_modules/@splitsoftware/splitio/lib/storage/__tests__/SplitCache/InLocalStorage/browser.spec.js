"use strict";

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

var _indexOf = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/index-of"));

var _tapeCatch = _interopRequireDefault(require("tape-catch"));

var _InLocalStorage = _interopRequireDefault(require("../../../SplitCache/InLocalStorage"));

var _Keys = _interopRequireDefault(require("../../../Keys"));

var _settings = _interopRequireDefault(require("../../../../utils/settings"));

(0, _tapeCatch.default)('SPLIT CACHE / LocalStorage', function (assert) {
  var cache = new _InLocalStorage.default(new _Keys.default((0, _settings.default)()));
  cache.flush();
  cache.addSplit('lol1', 'something');
  cache.addSplit('lol2', 'something else');
  var values = cache.getAll();
  assert.ok((0, _indexOf.default)(values).call(values, 'something') !== -1);
  assert.ok((0, _indexOf.default)(values).call(values, 'something else') !== -1);
  cache.removeSplit('lol1');
  var splits = cache.fetchMany(['lol1', 'lol2']);
  assert.true(splits.get('lol1') === null);
  assert.true(splits.get('lol2') === 'something else');
  values = cache.getAll();
  assert.ok((0, _indexOf.default)(values).call(values, 'something') === -1);
  assert.ok((0, _indexOf.default)(values).call(values, 'something else') !== -1);
  assert.ok(cache.getSplit('lol1') == null);
  assert.ok(cache.getSplit('lol2') === 'something else');
  assert.false(cache.checkCache(), 'checkCache should return false until localstorage has data.');
  assert.ok(cache.getChangeNumber() === -1);
  assert.false(cache.checkCache(), 'checkCache should return false until localstorage has data.');
  cache.setChangeNumber(123);
  assert.true(cache.checkCache(), 'checkCache should return true once localstorage has data.');
  assert.ok(cache.getChangeNumber() === 123);
  assert.end();
});
(0, _tapeCatch.default)('SPLIT CACHE / LocalStorage / Get Keys', function (assert) {
  var cache = new _InLocalStorage.default(new _Keys.default((0, _settings.default)()));
  cache.addSplit('lol1', 'something');
  cache.addSplit('lol2', 'something else');
  var keys = cache.getKeys();
  assert.true((0, _indexOf.default)(keys).call(keys, 'lol1') !== -1);
  assert.true((0, _indexOf.default)(keys).call(keys, 'lol2') !== -1);
  assert.end();
});
(0, _tapeCatch.default)('SPLIT CACHE / LocalStorage / Add Splits', function (assert) {
  var cache = new _InLocalStorage.default(new _Keys.default((0, _settings.default)()));
  cache.addSplits([['lol1', 'something'], ['lol2', 'something else']]);
  cache.removeSplits(['lol1', 'lol2']);
  assert.true(cache.getSplit('lol1') == null);
  assert.true(cache.getSplit('lol2') == null);
  assert.end();
});
(0, _tapeCatch.default)('SPLIT CACHE / LocalStorage / trafficTypeExists and ttcache tests', function (assert) {
  var cache = new _InLocalStorage.default(new _Keys.default((0, _settings.default)()));
  cache.addSplits([// loop of addSplit
  ['split1', '{ "trafficTypeName": "user_tt" }'], ['split2', '{ "trafficTypeName": "account_tt" }'], ['split3', '{ "trafficTypeName": "user_tt" }'], ['malformed', '{}']]);
  cache.addSplit('split4', '{ "trafficTypeName": "user_tt" }');
  assert.true(cache.trafficTypeExists('user_tt'));
  assert.true(cache.trafficTypeExists('account_tt'));
  assert.false(cache.trafficTypeExists('not_existent_tt'));
  cache.removeSplit('split4');
  assert.true(cache.trafficTypeExists('user_tt'));
  assert.true(cache.trafficTypeExists('account_tt'));
  cache.removeSplits(['split3', 'split2']); // it'll invoke a loop of removeSplit

  assert.true(cache.trafficTypeExists('user_tt'));
  assert.false(cache.trafficTypeExists('account_tt'));
  cache.removeSplit('split1');
  assert.false(cache.trafficTypeExists('user_tt'));
  assert.false(cache.trafficTypeExists('account_tt'));
  cache.addSplit('split1', '{ "trafficTypeName": "user_tt" }');
  assert.true(cache.trafficTypeExists('user_tt'));
  cache.addSplit('split1', '{ "trafficTypeName": "account_tt" }');
  assert.true(cache.trafficTypeExists('account_tt'));
  assert.false(cache.trafficTypeExists('user_tt'));
  assert.end();
});